name: Deploy API

on:
  issues:
    types: [opened]

jobs:
  parse-metadata:
    runs-on: ubuntu-latest
    outputs:
      api_name: ${{ steps.parse.outputs.api_name }}
      environment: ${{ steps.parse.outputs.environment }}
      apim_instance: ${{ steps.parse.outputs.apim_instance }}
      concurrency_group: ${{ steps.parse.outputs.concurrency_group }}
    steps:
      - name: Parse Issue Body
        id: parse
        uses: actions/github-script@v6
        with:
          script: |
            const body = context.payload.issue.body || "";

            // FunciÃ³n auxiliar para extraer valores basados en los encabezados del Issue Form
            function getValue(header) {
              // Busca contenido entre "### Header" y el siguiente "###" o fin de archivo
              const regex = new RegExp(`### ${header}\\s+([\\s\\S]*?)(?:###|$)`);
              const match = body.match(regex);
              return match ? match[1].trim() : "unknown";
            }

            const apiName = getValue('Nombre de la API');
            const environment = getValue('Ambiente Destino');
            const apimInstance = getValue('Instancia APIM');

            console.log(`Extracted: API=${apiName}, Env=${environment}, APIM=${apimInstance}`);

            core.setOutput('api_name', apiName);
            core.setOutput('environment', environment);
            core.setOutput('apim_instance', apimInstance);

            // -----------------------------------------------------------------------
            // CONFIGURACIÃ“N DE CONCURRENCIA
            // AquÃ­ definimos la "llave" que agruparÃ¡ las ejecuciones.
            // Si dos workflows tienen la misma llave y estÃ¡n corriendo, uno esperarÃ¡ al otro.
            // -----------------------------------------------------------------------

            // OPCIÃ“N 1: Bloqueo solo por Ambiente (Todos compiten por 'dev', 'qa', etc.)
            // const concurrencyGroup = `deploy-${environment}`;

            // OPCIÃ“N 2: Bloqueo solo por Instancia APIM (CompeticiÃ³n por recurso APIM)
            // const concurrencyGroup = `deploy-${apimInstance}`;

            // OPCIÃ“N 3: Bloqueo Combinado (Ambiente + APIM) -> MÃXIMA GRANULARIDAD
            // Solo bloquea si intentan desplegar al MISMO apim en el MISMO ambiente
            // ACTUALIZACIÃ“N: Se agrega apiName para permitir despliegues paralelos de distintas APIs
            const concurrencyGroup = `deploy-${apiName}-${environment}-${apimInstance}`;

            core.setOutput('concurrency_group', concurrencyGroup);
            console.log(`Concurrency Group set to: ${concurrencyGroup}`);

  deploy:
    needs: parse-metadata
    runs-on: ubuntu-latest
    environment: ${{ needs.parse-metadata.outputs.environment }}
    concurrency:
      group: ${{ needs.parse-metadata.outputs.concurrency_group }}
      cancel-in-progress: false
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Start Deployment Simulation
        run: |
          echo "ðŸš€ Inicio de Despliegue"
          echo "--------------------------------"
          echo "API Name:      ${{ needs.parse-metadata.outputs.api_name }}"
          echo "Environment:   ${{ needs.parse-metadata.outputs.environment }}"
          echo "APIM Instance: ${{ needs.parse-metadata.outputs.apim_instance }}"
          echo "--------------------------------"
          echo "ðŸ”’ Concurrency Group: ${{ needs.parse-metadata.outputs.concurrency_group }}"
          echo "â° Timestamp Start: $(date -u)"
          echo "--------------------------------"

      - name: Simulate Heavy Work (50s)
        run: |
          echo "â³ Simulando despliegue y validaciones (50 segundos)..."
          # Dormir para mantener el lock ocupado y forzar a otros a esperar
          sleep 50

      - name: Finish Deployment
        run: |
          echo "âœ… Despliegue Finalizado"
          echo "â° Timestamp End: $(date -u)"

      - name: Generate Log Artifact
        run: |
          file_name="deploy_log_${{ needs.parse-metadata.outputs.api_name }}_${{ github.run_id }}.txt"
          echo "Log de Despliegue" > $file_name
          echo "API: ${{ needs.parse-metadata.outputs.api_name }}" >> $file_name
          echo "Env: ${{ needs.parse-metadata.outputs.environment }}" >> $file_name
          echo "Start: $(date -u)" >> $file_name
          echo "Status: Success" >> $file_name

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: execution-log-${{ github.event.issue.number }}
          path: deploy_log_*.txt
